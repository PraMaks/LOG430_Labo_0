services:
  mongo-auth:
    image: mongo:5.0
    container_name: mongo_auth_db
    ports:
      - "27018:27017" # port different pour docker-compose
    restart: always

  mongo-admin:
    image: mongo:5.0
    container_name: mongo_admin_db
    ports:
      - "27118:27017" # port different pour docker-compose
    restart: always

  mongo-standard:
    image: mongo:5.0
    container_name: mongo_standard_db
    ports:
      - "27218:27017" # port different pour docker-compose
    restart: always

  redis:
    image: redis:7-alpine
    container_name: redis_server
    ports:
      - "6379:6379"
    restart: always

  auth:
    build: 
      context: ./src/backend/services/auth
      dockerfile: Dockerfile-Auth
    container_name: auth-service
    depends_on:
      - mongo-auth
    environment:
      - MONGO_HOST=mongo-auth
      - MONGO_PORT=27017
    ports:
      - "3010:3010"
    command: node app.js 

  admin:
    build: 
      context: ./src/backend/services/admin
      dockerfile: Dockerfile-Admin
    container_name: admin-service
    depends_on:
      - mongo-admin
    environment:
      - MONGO_HOST=mongo-admin
      - MONGO_PORT=27017
    ports:
      - "3020:3020"
    command: node app.js

  standard:
    build: 
      context: ./src/backend/services/standard
      dockerfile: Dockerfile-Standard
    container_name: standard-service
    depends_on:
      - mongo-standard
    environment:
      - MONGO_HOST=mongo-standard
      - MONGO_PORT=27017
    ports:
      - "3030:3030"
    command: node app.js

  krakend:
    image: devopsfaith/krakend:2.6
    container_name: krakend-gateway
    ports:
      - "80:80"
    volumes:
      - ./krakend:/etc/krakend
    command: ["run", "-d", "-c", "/etc/krakend/krakend.json"]
    depends_on:
      - auth
      - admin
      - standard
